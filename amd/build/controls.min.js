define(["core/ajax","jquery"],function(a,i){return{init:function(){var t=document.getElementById("local_ollamachat_messages"),e=document.getElementById("local_ollamachat_form"),o=document.getElementById("local_ollamachat_prompt"),c=document.getElementById("local_ollamachat_submit");function s(a,e,l){l=['<div class="local_ollamachat_message '+("user"===a?"local_ollamachat_user_message":"local_ollamachat_assistant_message")+'"'+(l?' id="'+l+'"':"")+">",'<div class="local_ollamachat_avatar">'+("user"===a?"ðŸ‘¤":"ðŸ¤–")+"</div>",'<div class="local_ollamachat_message_content">'+e+"</div>","</div>"].join("");t.insertAdjacentHTML("beforeend",l),r()}function n(a,e){var a=document.getElementById(a);a&&(a=a.querySelector(".local_ollamachat_message_content"))&&(a.innerHTML=e)}function r(){t.scrollTop=t.scrollHeight}o.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),o.addEventListener("keydown",function(a){"Enter"!==a.key||a.shiftKey||(a.preventDefault(),e.dispatchEvent(new Event("submit")))}),e.addEventListener("submit",function(a){a.preventDefault();var e,l,a=o.value.trim();a&&(o.disabled=!0,c.disabled=!0,s("user",a),o.value="",o.style.height="auto",s("assistant",'<div class="local_ollamachat_loader"><div></div><div></div><div></div></div>',e="local_ollamachat_msg_"+Date.now()),l=document.querySelector(".local_ollamachat_header").dataset.token,console.log(l),i.ajax({url:M.cfg.wwwroot+"/webservice/rest/server.php",type:"POST",data:{wstoken:l,wsfunction:"local_ollamachat_ask_with_knowledge",prompt:a,moodlewsrestformat:"json"},success:function(a){n(e,(a=>{if(!a)return'<div class="local_ollamachat_alert local_ollamachat_alert-info">No answer received</div>';let e=a;return(e=(e=(e=(e=e.replace(/(https?:\/\/[^\s]+)/g,function(a){a.replace(/^https?:\/\/(www\.)?/,"");return'<div class="local_ollamachat_link_item"><i class="local_ollamachat_link_icon fa fa-link"></i><a href="'+a+'" target="_blank" rel="noopener noreferrer">'+a+"</a></div>"})).replace(/`([^`]+)`/g,'<code class="local_ollamachat_inline_code">$1</code>')).replace(/```(\w*)\n([^`]+)```/gs,'<div class="local_ollamachat_code_container"><pre class="local_ollamachat_code_block"><code class="local_ollamachat_code $1">$2</code></pre></div>')).replace(/\n\n+/g,'</p><p class="local_ollamachat_paragraph">').replace(/\n/g,"<br>")).startsWith("<p>")||e.startsWith("<div")||e.startsWith("<pre")||(e='<p class="local_ollamachat_paragraph">'+e+"</p>"),console.log(e),e})(a.response))},error:function(){n(e,'<div class="alert alert-danger">Error connecting to the server</div>')}}).always(function(){o.disabled=!1,c.disabled=!1,o.focus(),r()}))})}}});