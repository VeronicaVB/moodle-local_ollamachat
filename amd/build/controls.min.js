define(["core/ajax","jquery","core/notification"],function(i,a,l){return{init:function(){var t=document.getElementById("local_ollamachat_messages"),l=document.getElementById("local_ollamachat_form"),e=document.getElementById("local_ollamachat_prompt"),o=document.getElementById("local_ollamachat_submit");function c(a,l,e){e=['<div class="local_ollamachat_message '+("user"===a?"local_ollamachat_user_message":"local_ollamachat_assistant_message")+'"'+(e?' id="'+e+'"':"")+">",'<div class="local_ollamachat_avatar">'+("user"===a?"ðŸ‘¤":"âœ¨")+"</div>",'<div class="local_ollamachat_message_content">'+l+"</div>","</div>"].join("");t.insertAdjacentHTML("beforeend",e),s()}function n(a,l){var a=document.getElementById(a);a&&(a=a.querySelector(".local_ollamachat_message_content"))&&(a.innerHTML=l)}function s(){t.scrollTop=t.scrollHeight}e.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),e.addEventListener("keydown",function(a){"Enter"!==a.key||a.shiftKey||(a.preventDefault(),l.dispatchEvent(new Event("submit")))}),l.addEventListener("submit",function(a){a.preventDefault();var l,a=e.value.trim();a&&(e.disabled=!0,o.disabled=!0,c("user",a),e.value="",e.style.height="auto",c("assistant",'<div class="local_ollamachat_loader"><div></div><div></div><div></div></div>',l="local_ollamachat_msg_"+Date.now()),i.call([{methodname:"local_ollamachat_ask_with_knowledge",args:{prompt:a,moodlewsrestformat:"json"}}])[0].done(function(a){n(l,(a=>{if(!a)return'<div class="local_ollamachat_alert local_ollamachat_alert-info">No answer received</div>';let l=a;return l=(l=(l=(l=(l=l.replace(/(https?:\/\/[^\s]+)/g,function(a){a.replace(/^https?:\/\/(www\.)?/,"");return'<div class="local_ollamachat_link_item"><i class="local_ollamachat_link_icon fa fa-link"></i><a href="'+a+'" target="_blank" rel="noopener noreferrer">'+a+"</a></div>"})).replace(/`([^`]+)`/g,'<code class="local_ollamachat_inline_code">$1</code>')).replace(/```(\w*)\n([^`]+)```/gs,'<div class="local_ollamachat_code_container"><pre class="local_ollamachat_code_block"><code class="local_ollamachat_code $1">$2</code></pre></div>')).replace(/\n\n+/g,'</p><p class="local_ollamachat_paragraph">').replace(/\n/g,"<br>")).startsWith("<p>")||l.startsWith("<div")||l.startsWith("<pre")?l:'<p class="local_ollamachat_paragraph">'+l+"</p>"})(a.response))}).fail(function(a){n(l,'<div class="alert alert-danger">Error connecting to the server</div>')}).always(function(){e.disabled=!1,o.disabled=!1,e.focus(),s()}))})}}});